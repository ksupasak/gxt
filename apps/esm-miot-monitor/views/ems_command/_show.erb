<% 

	ems_case = EMSCase.find params[:case_id]
	admit = Admit.find ems_case.admit_id
	commands = ems_case.commands
		
%>


<div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
					<div class="breadcrumb-title pe-3">Command </div>
					<div class="ps-3">
						<nav aria-label="breadcrumb">
							<ol class="breadcrumb mb-0 p-0">
								<li class="breadcrumb-item"><a href="javascript:;"><i class="bx bx-home-alt"></i><strong></strong></a>
								</li>
								<li class="breadcrumb-item active" aria-current="page"></li>
							</ol>
						</nav>
					</div>
					<div class="ms-auto">
				    <div class="btn-group" role="group" aria-label="First group">
				      <button type="button" class="btn btn-secondary btn_lang" lang="th">TH</button>
				      <button type="button" class="btn btn-outline-secondary btn_lang" lang="en">EN</button>
				    </div>
					</div>
					<div class="ms-auto">
						<div class="btn-group">
							<button type="button" class="btn btn-primary">Settings</button>
							<button type="button" class="btn btn-primary split-bg-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">	<span class="visually-hidden">Toggle Dropdown</span>
							</button>
							<div class="dropdown-menu dropdown-menu-right dropdown-menu-lg-end">	<a class="dropdown-item" href="javascript:;">Action</a>
								<a class="dropdown-item" href="javascript:;">Another action</a>
								<a class="dropdown-item" href="javascript:;">Something else here</a>
								<div class="dropdown-divider"></div>	<a class="dropdown-item" href="javascript:;">Separated link</a>
							</div>
						</div>
					</div>
				</div>
	<div class="row" >
	
	
	<div class="col-12 col-lg-8 col-xl-8">
	
		<div class="row">
			
		<div class="col-12">
			
			
			
			<div class="card radius-10">
				<div class="card-header bg-transparent">
					<div class="">
						
							<h6 class="row">
							<div class="col">
								แผนที่
							</div>
							<div class="col d-flex justify-content-end">
								right
							</div>
							</h6>
					
						<div class="dropdown ms-auto">
							<a class="dropdown-toggle dropdown-toggle-nocaret" href="#" data-bs-toggle="dropdown" aria-expanded="true"></a>
							<ul class="dropdown-menu" data-popper-placement="bottom-start" style="">
								<li>
									<a class="dropdown-item" href="javascript:;">Action</a>
								</li>
								<li>
									<a class="dropdown-item" href="javascript:;">Another action</a>
								</li>
								<li>
									<hr class="dropdown-divider">
								</li>
								<li>
									<a class="dropdown-item" href="javascript:;">Something else here</a>
								</li>
							</ul>
						</div>
					</div>
				</div>
				<div class="card-body">
					<style>
					       /* Set the size of the div element that contains the map */
					      #dashboard-map {
					        height: 100px;  /* The height is 400 pixels */
					        width: 100%;  /* The width is the width of the web page */
					       }
					      #dashboard-map-2 {
					        height: 100px;  /* The height is 400 pixels */
					        width: 100%;  /* The width is the width of the web page */
					       }
					    </style>
						
					<!-- <div class="row">
					<div class="col-md-6">
						<label for="inputLastName1" class="form-label"><span class="t" text="address" >ที่อยู่</span></label>
						<div class="input-group"> <span class="input-group-text bg-transparent"><i class="bx bxs-user"></i></span>
						<input name='record[address]' id="record_address" value="<%=ems_case.address%>" class="form-control border-start-0 " type="text" placeholder="ที่อยู่" aria-label="default input example">
						</div>
					</div>
					<div class="col-md-6">
						<label for="inputLastName1" class="form-label"><span class="t" text="location">พิกัด</span></label>
						<div class="input-group"> <span class="input-group-text bg-transparent"><i class="bx bxs-user"></i></span>
						<input name='record[latlng]' id="record_latlng" value="<%=ems_case.latlng%>" class="form-control border-start-0 " type="text" placeholder="ที่อยู่" aria-label="default input example">
						</div>
					</div>
					</div>
					<br/>
					 -->
					<div id="dashboard-map-c" style="height: 300px">
						map
					</div>
					<%#render_map  'dashboard-map', :center=>'13.69313508354787, 100.69198345629769', :main_pin=>{:latlng=>'13.656436171031853, 100.70025782511473'} %>
					
				
					<script>
					
						latlng = [13.69313508354787, 100.69198345629769]
						<% if Setting.get('aoc_center') %>
						latlng = [<%=Setting.get('aoc_center') %>]
						<% end %>
						<% if ems_case.latlng and ems_case.latlng.index(',') %>
						latlng = [<%=ems_case.latlng%>]
						<% end %>
						
						
						
						mapc = new EMSMap('dashboard-map-c');
						
						mapc.setPosition(latlng[0], latlng[1])
						mapc.setMarkerPosition(latlng[0], latlng[1])						
						mapc.changeMarkerPosition(function(marker){

						}.bind(this))
						
						
						
						<% for cm in commands %>
							
						mapc.ready(function(){
							
							<%
								loc = cm.ambulance.last_location
								if loc and loc.index(',')
									loc=loc.split(",").collect{|i| i.to_f}
							%>
							var start = new google.maps.LatLng(<%=loc[0]%>, <%=loc[1]%> )
							var target = new google.maps.LatLng(latlng[0], latlng[1] )
							
							directionsService = new google.maps.DirectionsService;
				  	      	directionsDisplay = new google.maps.DirectionsRenderer;
				  		    directionsDisplay.setMap(mapc.map);
							
							mapc.drawPath(directionsService,directionsDisplay, start,target,[],function(rs){
								
								
								a = $('#send-msg-<%=cm.id%>')
								
								if(a.attr("href").indexOf("distance")==-1){
									a.attr("href", a.attr('href')+"&distance="+rs['distance']['text']+"&duration="+rs['duration']['text'])
								}
								
								$('#ambu-status-<%=cm.id%>').html(" Distance : "+rs['distance']['text'] + " Time : "+rs['duration']['text'])
								
								
								
							}.bind(this));
							<% end %>
						}.bind(this));
						
						<% end %>
		
						
						mapc.init()
					</script>
			
					
				</div>
			</div>
	
	</div>
	
	
	
	
	
	
	
	<div class="col-12 ">
		
		
		
		<div class="card">
			<div class="card-header">
				<h6 class="row">
				<div class="col">
				ชุดปฏิบัติการ
				</div>
				<div class="col d-flex justify-content-end">
					
				</div>
				</h6>
			</div>
			<div class="card-body">
				
				
				
				
		
		
		<% 
		
	
		for cm in commands
		%>
		
		<div class="card" style="background:#f7f7ff">
				<div class="card-header">
				EMS-001
				
				<span id="c<%=cm.id%>"></span>
				<a href="<%=get_path "update?id=#{cm.id}" %>" class="btn btn-warning btn-sm" data-remote="true"  style="float:right;" data-remote-update="command">แยก Case </a>
				<a href="<%=get_path "update?id=#{cm.id}" %>" class="btn btn-info btn-sm" data-remote="true"  style="float:right;margin-right:5px" data-remote-update="command">แก้ไข</a>
				<a href="<%=get_path "destroy?id=#{cm.id}" %>" class="btn btn-danger btn-sm" data-remote="true"  style="float:right;margin-right:5px" data-remote-update="command">ลบ</a>
				
				</div>
				
				<div class="card-body">
					
					
				<div class="row">
					
				<div class="col-4">
				
												<p class="mb-3">
												คำสั่งการ :
											    </p>
												<div class="input-group">
												<textarea name="record[chief_complain]" id="record_chief_complain" class="form-control">
<%=cm.init_command%>  
												</textarea>
												</div>
<br/>
												<p class="mb-3">
												รถพยาบาล :
											    </p>
												<div class="input-group">
												<div class="form-control">
													<%=cm.ambulance.name%>
													<br/>
													<%=cm.ambulance.last_location%>
													<br/>
													<span id="ambu-status-<%=cm.id%>"></span>
												</div>
												</div>				
				<p class="">
				เจ้าหน้าที่ :
			    </p>
				<div class="form-control">
					
					
					<% for j in cm.providers 
					
						name = j.name
						provider = nil
						provider = j.provider
						name = provider.name if provider
					%>
				
						<div class="chip chip-md">
							<img src="/rocker/assets/images/avatars/avatar-1.png" alt="Contact Person">
							<%=name%>
						</div><br/>
				
					<% end %>
					
					
							
				
				</div>
				
				
				
				<br/>
				<a href="<%=get_path "send_message?id=#{cm.id}" %>" id="send-msg-<%=cm.id%>" class="btn btn-success btn-sm" data-remote="true"  data-remote-update="c<%=cm.id%>">ส่งคำสั่ง Line</a>
				
					<br/><br/>

				
				</div>
				<div class="col-8">
								
							<form action="<%=get_path "update_tracking" %>" method="POST">
								
									
								<%
									
								logs = AdmitLog.where(:ems_command_id=>cm.id, :admit_id=>admit.id).sort(:sort_order=>1).all
									
								parent_map = {}
								%>
								<p class="text-center font-weight-bold"></p>
								<table class='table'>
								<thead>
									<tr>
										<th>รายการ</th><th>เวลา</th><th>Tdiff</th><th>เลข กม.</th><th>Actions</th><th>ETA</th>
								
									</tr>
								</thead>
									<tbody>
								<% for i in logs 
	
								parent_map[i.sort_order] = i
		
								%>
							
								<tr>
									<td>
										<%=i.name%>
									</td>
									<td><% if i.stamp %>
										
										<%=i.stamp.localtime.strftime("%H:%M")%> 
										
										<v class="time-alert">+<%=(i.stamp - admit.created_at).to_i/60 %>m</v>
										<% end %>
			
									</td>
									<td>
										<% if i.stamp and i.parent and p = parent_map[i.parent] and p.stamp 
										lap = (i.stamp - p.stamp).to_i/60
										 %>
										<w><%= lap %>m</w>
										<% end %>
									</td>
									<td>
										<% if i.status=='COMPLETED'%>
										<input type="text" name="log[<%=i.id%>]mile_meter" class="form-control" value="<%=i.mile_meter%>" style="width:100px">
										<% end %>
									</td>
								
									<td>	<%=i.note%>
										<% if i.status=='PENDING'%>
									  	<%= link_to 'Check', "#{get_path "check"}?id=#{cm.id}&admit_log_id=#{i.id}", :class=>'btn btn-sm btn-success check-log' %>
										<% end%>
									</td>
									
									<%=i.status%><%
											
																		#route = AocCaseRoute.where(:arrival_log_id=>i.id).first
									route = AocCaseRoute.where(:departure_log_id=>i.id).first # unless route
									
									if route
										
									%>
									<td rowspan="2" valign="middle">
								
									   ETA
									   (<%=format("%0.1f",route.act_duration/60) if route.act_duration%> min, <%=format("%0.1f",route.act_distance/1000.0) if route.act_distance%> km)
									   <br/>
									 <%=route.status%>
									</td>
									<% else %>
									<td></td>
									<% end %>
									
								</tr>

								<% end %>
									</tbody>
								</table>
	
								
								
								<input type="submit" name="Update"> <a href="<%=get_path "x?id=#{cm.id}" %>" id="add-path-<%=cm.id%>" class="btn btn-primary btn-sm" data-remote="true"  data-remote-update="c<%=cm.id%>">เพิ่มเส้นทาง</a>
								
								
							</form>
								
								
								
								
								
								
								
								
				</div>
				</div>	
					
					
					
					
					
					
				
	
				
			
			
				</div>
				
				<p class="p-3 mb-0">
				
			
			</p>
				
		</div>
		
		<% end %>
		
		
		<script>
			
			$('.check-log').click(function(e){
				
				target = $(this).attr('href')
				
				$.ajax({
			    url: target,
				  context: document.body
				}).done(function(html) {
					
					
					reload_command_content();
				  
				});
				
				e.preventDefault();
				
			})
			
		</script>
		
			<a href="<%=get_path "create?case_id=#{ems_case.id}" %>" class="btn btn-info" data-remote="true" data-remote-update="command">เพิ่มทีม</a>
			
			
		</div>
	</div>	
		
		
		
	</div>
	
</div>

</div>
	
	
		<div class="col-12 col-lg-4 col-xl-4">
			
			
			<div class="card">
				
					<div class="card-header">
				
					<h6 class="row">
					<div class="col">
					Event
					</div>
					<div class="col d-flex justify-content-end">
						right
					</div>
					</h6>
				
					</div>
				
					<div class="card-body message-partial" style="overflow:scroll;">
							<!-- <div style="height:3000px;background:red">f</div> -->
					</div>
					
			
		</div>
	
	
	</div>
	
	
	

	<script>
		
		
		
	
		
		function command_process(lines){
			
			
			objs = JSON.parse(lines[1])
			
			console.log(objs)
			
	
			
			// console.log(lines[0].split(" ")[0])
			if(lines[0].split(" ")[0]=='Zone.Message'){
			
				reload_message("<%=admit.id%>")
		
			}
	  
			
		}
		
		current_process = command_process
		
		var message_admit_id= null
		
		function reload_message(admit_id){
		


		message_admit_id = admit_id
	
		// reload_nurse_note(admit_id)
		// reload_medication(admit_id)
		

		$.ajax({
		  url: "<%= "../EmsParamedic/message_partial"%>?admit_id="+message_admit_id,
		  context: document.body
		}).done(function(data) {
		  $( '.message-partial' ).html(data);
	  	 // alert($( '.chat' ).height())
	  $('.panel-body').scrollTop(100000000)
		 

		});
	
		}
		
		reload_message("<%=admit.id%>")
		
	
		refresh_remote()
	</script>