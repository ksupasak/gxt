
<h2>เพิ่มรายการ Commander</h2>
		
		
<% 

ems_case  = EMSCase.find params[:case_id]

if request.post? 


	
if params[:record]

	p = params[:record]
	
	# patient_id = nil
# 	patient = Patient.find p[:patient_id] if p[:patient_id]
#
# 	unless patient
#
# 		patient = Patient.create :name=>p[:patient_name], :hn=>p[:patient_hn], :public_id=>p[:patient_cid], :contact_name=>p[:contact_name], :contact_phone=>p[:patient_phone],:zone_id=>session[:current_zone]
#
# 	end
#
# 	patient_id = patient.id if patient
#
#
# 	admit = Admit.create :zone_id=>session[:current_zone], :patient_id=> patient_id
#
# 	p[:admit_id] = admit.id
# 	p[:zone_id] = session[:current_zone]
# 	p[:patient_id] = patient_id
# 	p[:status] = "New"
#
# 	counter_key = Time.now.strftime("%y%m")
#
# 	counter = EMSCaseCounter.where(:key=>counter_key).first
# 	counter = EMSCaseCounter.create(:key=>counter_key, :count=>0) unless counter
#
# 	case_no = "#{counter_key}-#{format('%04d',counter.count+1)}"
#
# 	p[:case_no] = case_no
#
	p[:case_id] = ems_case.id
	
	record = EMSCommand.create p
	
	providers = record.providers
	for i in providers
		i.destroy
	end
	
	if params[:providers]
	for i in params[:providers].split(",")
			
		command_provider = EMSCommandProvider.create :command_id=>record.id, :provider_id=>i
		
	end
	end
	
		
	
	
end
	


%>
Update ... <%=Time.now%>
<META HTTP-EQUIV="Refresh" CONTENT="1;URL=show?id=<%=ems_case.id%>">


<% else %>

<%
	
	ems_command = EMSCommand.new
	
	init_command = "เหตุ : #{ems_case.patient_info} อาการ : #{ems_case.chief_complain} รหัส : #{ems_case.init_code.name}"
	ems_command.init_command = init_command
	
%>

<form action="<%= get_path 'create'%>" method="post" data-remote='true' data-remote-update="reqeust-panel">
<% fieldset(:record) do |f| %>	
<input type="hidden" name="case_id" value="<%=ems_case.id%>">
<%= inline(this,:'_form', :this=>this, :f=>f, :record=>ems_command, :ems_case=> ems_case)  %>


<% end %>
<input type="submit" name="create" value="Create" class="btn btn-success"> 

<a href="<%=get_path "show?case_id=#{ems_case.id}" %>" class="btn " data-remote="true" data-remote-update="command">Cancel</a>


</form>

<div id="reqeust-panel">

</div>
<% end %>

<script>
	refresh_remote()
</script>