
<%= inline(this,:'../lib/_map')  %>

<%= inline(this,:'_init')  %>



<style>
       /* Set the size of the div element that contains the map */
      #dashboard-mapx {
        height: 400px;  /* The height is 400 pixels */
        width: 100%;  /* The width is the width of the web page */
       }

    </style>

<%

record = @current_case

     if record

     com_list = EMSCommand.where(:case_id=>record.id, :ambulance_id=>@current_ambulance.id).all

    if com_list.size==1

     com = com_list[0]
     admit = record.admit

     last_mile = com.ambulance.last_mile

     last_log = admit.logs.where(:status=>'PENDING').sort(:sort_order=>1).first
	 if last_log
     current_route =  AocCaseRoute.where('$or'=>[{:departure_log_id=>last_log.id},{:arrival_log_id=>last_log.id} ]).first
     previous_log = admit.logs.where(:admit_id=>last_log.admit_id, :sort_order=>last_log.sort_order-1).first if last_log


     last_mile = previous_log.mile_meter if previous_log  and  previous_log.mile_meter
 	  end
   end



%>

<style>
.modal-header{
  padding:5px;
}
.modal-body{
  padding:5px;
}

.modal-footer{
  padding:5px;
}

</style>

<% if last_log %>
<!-- Button trigger modal -->
<!-- Modal -->
<div class="modal fade" id="modal_tracking" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog modal-sm " style="max-width:300px">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel"><span class="tracking_msg"> <%=last_log.name %></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="font-size:1.5em">
        <center>
        <input type="text" class="mile_meter" value="<%=last_mile %>" style="width:120px;text-align:center;font-size:1.5em"/>
        </center>

      </div>
      <div class="modal-footer d-flex justify-content-between">
        <div class="col-4">
        <a type="button" class="btn btn-secondary btn-success mile-plus">+</a>
        <a type="button" class="btn btn-secondary btn-danger mile-minus">-</a>
        </div>
        <div class="col-7" style="text-align:right">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary mile-submit">Submit</button>
        </div>
        <script>
            $('.mile-plus').click(function(e){
                v = parseInt($('.mile_meter').val())
                $('.mile_meter').val(v+1)
            })
            $('.mile-minus').click(function(e){
                v = parseInt($('.mile_meter').val())
                $('.mile_meter').val(v-1)
            })

            $('.mile-submit').click(function(e){
                v = parseInt($('.mile_meter').val())


                // Assign handlers immediately after making the request,
                // and remember the jqxhr object for this request
                var jqxhr = $.post( "check?id=<%=com.id%>&admit_log_id=<%=last_log.id%>&mile_meter="+v, function() {
                  console.log("sueccess")
                  // alert( "success" );
                  	window.location.reload();
                })
                  .done(function() {
                       console.log( "second success" );
                  	window.location.reload();
                  })
                  .fail(function() {
                       console.log( "error" );
                    	window.location.reload();
                  })
                  .always(function() {
                       console.log( "finished" );
                    	window.location.reload();
                  });

                // Perform other work here ...

                // Set another completion function for the request above
                jqxhr.always(function() {
                     console.log( "second finished" );
                  	window.location.reload();
                });

                	window.location.reload();

              //
              // $.post( "check?id=<%=com.id%>&admit_log_id=<%=last_log.id%>&mile_meter="+v, function( data ) {
              //
              //   location.reload();
              //
              // });

            })

        </script>

      </div>
    </div>
  </div>
</div>
</div>
<% end %>



<% end %>


<div class="row no-gutters g-0 vh-100" style="border:0px solid;margin-top:40px">
<div class="col-12">
<div id="dashboard-map" class="h-100" style="border:0px solid" >
  map
</div>
</div>

<div class="row o-gutters g-0 fixed-bottom" style="height:110px">

<div class="col-12">
  <div class="row g-1" style="padding-top:5px">


        <% if record %>
    <div class="col-3">
      <button type="button" class=" info-button btn btn-primary px-4  radius-5" style="width:100%;">
        INFO</button>
    </div>
	     <% if current_route %>
    <div class="col-3">
 
      <!-- https://www.google.com/maps/search/?api=1&query=13.0106708,77.5552532
      <a href="https://www.google.com/maps/search/?api=1&query=<%=current_route.stop_latlng.split().join()%>" class="btn btn-warning text-white px-4  radius-5" style="width:100%;">
        NAV</a>-->
		         <!-- https://www.google.com/maps/dir//13.6086178,100.5946353/@13.6085003,100.5536058,13z?entry=ttu -->
        <a href="https://www.google.com/maps/dir//<%=current_route.stop_latlng.split().join()%>/@<%=current_route.stop_latlng.split().join()%>,18z?entry=ttu" class="btn-nav btn btn-warning text-white px-4  radius-5" style="width:100%;">
          NAV</a>


   
    </div>

     <% end %>
      <% if last_log %>
      <div class="col-3">
        <a href="#"  data-bs-toggle="modal"  data-bs-target="#modal_tracking" class=" btn-tracking btn btn-success   radius-5" style=" width:100%;overflow:hidden;text-overflow: ellipsis;white-space: nowrap;">
          <%=last_log.name%></a>
      </div>
      <%  end %>
        <% if true %>
      <div class="col-3">

    

          <a href="#" class="btn-nav cap-btn btn btn-danger text-white px-4  radius-5" style="width:100%;">
            Video</a>
			<script>
				$('.cap-btn').click(function(){
					
					device_interface.startVideoCall("<%=record.case_no%>")
					
					
				})
				
			</script>		

     
      </div>
	       <% end %>

    <% end %>

      <div class="col">
        <!-- <button type="button" class="btn btn-primary noti-button"  data-bs-toggle="modal" data-bs-target="#modal_notification">Notification</button>
        <button type="button" class="btn btn-primary noti-button"  data-bs-toggle="modal" data-bs-target="#modal_tracking">Tracking</button> -->
          <!-- <button type="button" class="btn btn-primary px-4 radius-30">Primary</button> -->
      </div>
      <div class="col">
          <!-- <button type="button" class="btn btn-primary  px-4 radius-30">Primary</button> -->
      </div>
  </div>

</div>

</div>

<div class="row">
<div class="col">
	<!-- Button trigger modal -->


	<!-- Modal -->
	<div class="modal fade" id="modal_notification" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" style="display: none;">
		<div class="modal-dialog modal-sm">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title noti_title" id="exampleModalLabel">Notification</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
                <div class="noti_msg"></div>
                <input type="hidden" class="noti_url_accept" value=""/>
                <input type="hidden" class="noti_url_denied" value=""/>

          <br/>
        </div>
				<div class="modal-footer">
          <center>
					<button type="button" class="btn btn-danger modal_notification_denied" data-bs-dismiss="modal">Reject</button>
					<button type="button" class="btn btn-success modal_notification_accept">Accept</button>
          </center>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="modal-x" style="display: none;" >
<div class="modal-backdrop fade show"></div>
</div>


<% if @current_case 
r = @current_case

	
cls = ""	
if r.init_code
case r.init_code.color
when 'red'
	cls = 'alert-danger'	
when 'yellow'
	cls = 'alert-warning'	
when 'green'
	cls = 'alert-success'	
end
end



%>


<div class="modal fade" id="modal_info" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" style="display: none;">
	<div class="modal-dialog modal-md">
		<div class="modal-content">
			<div class="modal-header <%=cls%>">
				<h5 class="modal-title noti_title" id="exampleModalLabel">Case : <%=@current_case.case_no %> </h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
           
		   	<div class="row">
				<div class="col-6">
				<b>Patient : </b> <%=r.patient_name%>
				</div>
				
				
			<div class="col-6">
			Sex : <%= r.patient_gender %> Age : <%= r.patient_age%>yr
			</div>
			
		
		
			
				<div class="col-6">
					T : <%=r.created_at.strftime("%H:%M:%S")%>
					(<%=format("%.1f",(Time.now - r.created_at)/60.0)%>m)
				</div>
				
				
			<div class="col-6">
			CID : <%= r.patient_cid %>
			</div>
				
				
				<div class="col-6">
				Phone : <%= r.contact_name %>
				
				<div class="card">
				<div class="card-body">
				<%= r.contact_phone %>
				</div>
				</div>
				
				</div>
				
		
				
				
				<div class="col-6">
					
					Location : <br/> 
					<div class="card">
					<div class="card-body">
					<%= r.location %> &nbsp;
					</div>
					</div>
					
				</div>
				
				<div class="col-12">
					
					Chief Complain : <br/> 
					<div class="card">
					<div class="card-body">
					<%= r.chief_complain %>
					</div>
					</div>
					
				</div>
				
				
				<div class="col-12">
					
					Init CBD : <br/> 
					
					<% if r.init_code
					
					cls = ""	
					case r.init_code.color
					when 'red'
						cls = 'alert-danger'	
					when 'yellow'
						cls = 'alert-warning'	
					when 'green'
						cls = 'alert-success'	
					end
					
					
					 %>
					<div class="card">
					<div class="card-body  <%= cls%>">
					<%= r.init_code.name if r.init_code %>
					</div>
					</div>
					<% else %>
					<div class="card">
					<div class="card-body alert alert-danger">
						N/A
					</div>
					</div>
					<% end %>
					
				</div>
				
				<div class="col-6">
				<b>Dispatch : </b> <%=r.ambulance.name if r.ambulance%>
				</div>
			
				<div class="col-6">
				Type : <%= r.case_type %> 
				</div>
				
			
				<div class="col-6">
				
					<%
						
						commands = r.commands
						if commands.size > 0 	
							t = commands[0].created_at
					%>
				T : <%=t.strftime("%H:%M:%S")%>
				(<%=format("%.1f",(Time.now - t)/60.0)%>m)
						<% end %>
				</div>
				
			<div class="col-6">
			Channel : <%= r.channel.name if r.channel%> 
			</div>
			
				
				
				<div class="col-6">
					
					Activation Time : <br/> 
					<div class="card">
					<div class="card-body alert-info">
					<%=r.activation_time%> mins
					</div>
					</div>
					
				</div>
				
			
				
				<div class="col-6">
					
					Response Time : <br/> 
					<div class="card">
					<div class="card-body alert-info">
					<%=r.response_time%> mins
					</div>
					</div>
					
				</div>
			</div>
		   
			</div>
			<div class="modal-footer">
      <center>
				<button type="button" class="btn " data-bs-dismiss="modal">Close</button>
      </center>
			</div>
		</div>
	</div>
	
<% end %>







<script>



  $(document).ready(function(){



  latlng = [13.69313508354787, 100.69198345629769]


  <% if record and  record.latlng and record.latlng.index(',') %>
  latlng = [<%=record.latlng%>]
  <% end %>



  map1 = new EMSMap('dashboard-map',{movable:true});
  map1.setPosition(latlng[0], latlng[1])
  map1.setMarkerPosition(latlng[0], latlng[1])
	map1.changeMarkerPosition(function(marker){

  });

  var m_hos = {}
	 
	 
	map1.ready(function(){
		// const image = "https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png";
		// const image = "<%=url_for('ems/h0.png')%>";

	<% 
		hospitals = EMSHospital.all()
		
		for i in hospitals %>

	var posx = new google.maps.LatLng(<%=i.latlng%> )
	var image = "<%=url_for("ems/h#{i.level}.png")%>";
	 markerx = new google.maps.Marker({position: posx, map: map1.map,
		 icon:image
	 })
	 markerx.addListener("click", () => {
		 select_hospital('<%=i.id%>')
	 });

	 m_hos['<%=i.id%>'] = markerx;

	<% end %>
	 
	 
	 
	 
	 


});

  // map1.init()

})

</script>
<%= init_map %>


<div class="msg" style="color:gray;font-size:0.8em"></div>

<div class="msg2" style="color:gray;font-size:0.8em"></div>

<script>




  var noti_status=false;
  var modal_id = null;

 function modal(id){

     $(id).css('display','block')
     $(id).addClass('show')
     modal_id= id
     $(id).find('button[data-bs-dismiss="modal"]').each(function(){
       $(this).click(function(){
          $(modal_id).hide()
          $('.modal-x').hide()
       })
     })
     $('.modal-x').show()


     // $('.modal-backdrop').addClass('show')

 }

$('.btn-tracking').click(function(){
// $('#modal_notification').modal('show');
modal('#modal_tracking')

})

$('.info-button').click(function(){
	
	modal('#modal_info')
	
})


$('.noti-button').click(function(){
  // $('#modal_notification').modal('show');
modal('#modal_notification')

})



  function show(msg){
    $('.msg2').html(msg)
  }

  var ws = null

  function connect(){


  // ws  = new WebSocket('wss://' + window.location.host + "/<%=@context.settings.name%>/Home/index");

  ws  = new WebSocket('wss://' + window.location.host + "/ws/<%=@context.settings.name%>/Home/index");


  ws.onopen    = function()  { show('websocket opened');

  	// ws.send('WS.Select name=<%=session.id%>\n["Zone <%="miot/#{@context.settings.name}/z/#{@current_zone.name}"%>","ZoneUpdate zone_id=*","EMSUpdate event_id=*", "Alert station_id=*","Data.Image station_id=*"]')
    ws.send('WS.Select name=<%=session.id%>\n["EMSUpdate <%="miot/#{@context.settings.name}/z/#{@current_zone.name}/EMT"%>", "ZoneUpdate zone_id=*", "EMSUpdate <%="miot/#{@context.settings.name}/z/#{@current_zone.name}/IOT"%>"]')


  };


  ws.onerror = function(){

    noti_msg('Reconnect in 5 seconds')
    ws.close()
    // alert('Reconnect in 5 sec')
    setTimeout(function () {
        // window.location.href = "index"; //will redirect to your blog page (an ex: blog.html)
        connect()

     }, 10000); //will call the function after 2 secs.


  }

  ws.onclose   = function()  { show('websocket closed');

 	// setTimeout(function () {
  //      // window.location.href = "index"; //will redirect to your blog page (an ex: blog.html)
  //      connect()
  //
  //   }, 10000); //will call the function after 2 secs.


  }

  ws.onmessage = function(m) {

	  console.log(m.data)


	    $('.msg').html("Network is online : "+(m.timeStamp/1000)+ " s" )


		lines = m.data.split("\n")


    // when new case

		if(lines[0].split(" ")[0]=='Zone.Refresh'){

			window.location.reload();

		}else
		
    if(lines[0].split(" ")[0]=='EMSUpdate'){

       obj = JSON.parse(lines[1])
       console.log(obj)

       if(obj['alert']=="1"||obj['alert']=="0"){
         console.log(obj)

		   }


    else
	
	if(lines[0].split(" ")[0]=='ZoneUpdate'){
		
			update(lines)


	}
	else
	
	{

       jQuery.each(obj['ems_data'], function (key, val) {

       // Object.values().forEach(val => {

         // console.log(val)
         jQuery.each(val['commands'], function (key, cmd) {
         // Object.values(val['commands']).forEach(cmd => {

           // console.log('EMT noti')


           if(cmd['emt_deiver_code']==null){
             if(noti_status==false){

            // console.log(cmd)
             $('.noti_title').html("Accept Case");

             $('.noti_msg').html("Case No : "+val['case_record']['case_no']+"<br/>Location : "+val['case_record']['location']+"<br/>Tel : "+val['case_record']['contact_phone']);



             $('.noti_url_accept').val("update_record?id="+val['case_record']["_id"]+"&cmd=case_accept"+"&command_id="+cmd['_id'])
             $('.noti_url_denied').val("update_record?id="+val['case_record']["_id"]+"&cmd=case_denied"+"&command_id="+cmd['_id'])
             // $('#modal_notification').modal('show');
             modal('#modal_notification')

             noti_status = true;
            }


           }


         });

         jQuery.each(val['routes'], function (key, route) {
         // Object.values(val['routes']).forEach(route => {



           if(route['response']==null){


             console.log('EMT route')



               if(noti_status==false){
              console.log('EMT case noti')
              // console.log(cmd)

               $('.noti_title').html("Route Update / Transfer");

               $('.noti_msg').html("Change Route");

               $('.noti_url_accept').val("update_record?id="+val['case_record']["_id"]+"&cmd=route_accept"+"&route_id="+route['_id'])
               $('.noti_url_denied').val("update_record?id="+val['case_record']["_id"]+"&cmd=route_denied"+"&route_id="+route['_id'])
               // $('#modal_notification').modal('show');
               modal('#modal_notification')

               noti_status = true;



             }

           }


         });




       });

	   }

    }else

    if(lines[0].split(" ")[0]=='Zone.Message'){

			// reload_message()

	}else{}
	
	



  }

}



  $('.modal_notification_accept').click(function(){
    url = $('.noti_url_accept').val()
    window.location=url

  })

  $('.modal_notification_denied').click(function(){
    url = $('.noti_url_denied').val()
    window.location=url

  })



		var ambu_map = {}


		function update(lines){

			// console.log(lines)

			obj = JSON.parse(lines[1])

			// console.log(obj['ambu_data'])

			var keys = Object.keys(obj['ambu_data']);

			var values = keys.map(function(v) { return obj['ambu_data'][v]; });



			for(ai in values){

				a = values[ai]

				if(a['last_location']!=""&&a['last_location'].indexOf(",")){



				map_icon = {
				  path: car,
				  scale: 0.9,
				  strokeColor: 'white',
				  strokeWeight: .10,
				  fillOpacity: 1,
				  fillColor: '#303bef',
				  offset: '5%',
				// size: new google.maps.Size(sizeX, sizeY),
//         				origin: new google.maps.Point(0, 0),
//         				anchor: new google.maps.Point(sizeX/2, sizeY/2),
				  // rotation: parseInt(heading[i]),
				  anchor: new google.maps.Point(10, 25) // orig 10,50 back of car, 10,0 front of car, 10,25 center of car
				};



				var t = a['last_location'].split(",")
				var pos = new google.maps.LatLng(parseFloat(t[0]), parseFloat(t[1]))

        marker = ambu_map[a['_id']]

				var image = "<%=url_for("ems/ambu.png")%>";



				if(marker==null){


						marker_map = new google.maps.Marker({position: pos,icon: image,  map: map1});
						ambu_map[a['_id']] = marker_map
							console.log('new')


				}else{
						marker_map = 	ambu_map[a['_id']]
						marker_map.setPosition(pos)
						console.log('set')

				}

				}



				// latlngbounds.extend(pos);

			}



			// map.fitBounds(latlngbounds);

		}



function noti_msg(msg) {
	Lobibox.notify('warning', {
		pauseDelayOnHover: true,
		size: 'mini',
		rounded: true,
		delayIndicator: false,
		icon: 'bx bx-error',
		continueDelayOnInactiveTab: false,
		position: 'top center',
		msg: msg
	});
}


// function update(lines){
//     console.log(lines)
//     show(lines[0])
//   }
$(document).ready(function(){
  connect()

})

function resize(height){
  alert(height);
}
	// modal('#modal_info')

</script>
