<%
	
date = Time.now
months = %w{มกราคม กุมภาพันธ์ มีนาคม เมษายน พฤษภาคม มิถุนายน กรกฎาคม สิงหาคม กันยายน ตุลาคม พฤศจิกายน ธันวาคม}
mon_th = months[date.strftime("%m").to_i-1]
patient = Patient.where(:hn=>params[:hn]).first


admits = Admit.where(:patient_id=>patient.id).all

records = DataRecord.where(:admit_id=>{'$in'=>admits.collect{|i| i.id}}).order(:stamp.desc).all
	
%>
<link href="<%=url_for 'css/opd.css'%>" rel="stylesheet">
<svg width="0" height="0">
    <defs>
        <g id="t-up">
        <polygon points="10,0 0,20 20,20" class="triangle" />
        </g>
        <g id="t-down">
        <polygon points="0,0 20,0 10,20" class="triangle" />
        </g>        
    </defs>
    <style>
    .triangle{fill:#51A451;}
    .symbol{height:20px;width:20px;}
    </style>
</svg>
<div class="p-name" style="padding:20px">
HN <%=patient.hn%>: <%= patient.prefix_name %><%= patient.first_name %> <%= patient.last_name %>ฉันท์มิตร แก้วพรหมมาลย์
</div>

<div class="row">
    <div class="col-6">
    <div class="d-result ">
    Blood Pressure
    </div>
    </div>
    <div class="col">
    <div class="d-result ">
    Weight
    <div id="barchart"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    
    <script>
    var weights = JSON.parse('[{"date":"2020-05","value":"50"},{"date":"2020-04","value":"60"},{"date":"2020-03","value":"70"},{"date":"2020-02","value":"55"}]')
    
    var margin = {top: 20, right: 20, bottom: 70, left: 40},
        width = 500 - margin.left - margin.right,
        height = 250 - margin.top - margin.bottom;
    
    // Parse the date / time
    var	parseDate = d3.time.format("%Y-%m").parse;
    
    var x = d3.scale.ordinal().rangeRoundBands([0, width], .05);
    
    var y = d3.scale.linear().range([height, 0]);
    
    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom")
        .tickFormat(d3.time.format("%Y-%m"));
    
    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .ticks(5);
    
    var svg = d3.select("#barchart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", 
              "translate(" + margin.left + "," + margin.top + ")");
    
    data = weights

    data.forEach(function(d) {
        d.date = parseDate(d.date);
        d.value = +d.value;
    });
    
    x.domain(data.map(function(d) { return d.date; }));
    y.domain([0, d3.max(data, function(d) { return d.value; })]);
    
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", "-.55em")
        .attr("transform", "rotate(-90)" );
    
    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("kg");
    
    svg.selectAll("bar")
        .data(data)
        .enter().append("rect")
        .style("fill", "steelblue")
        .attr("x", function(d) { return x(d.date); })
        .attr("width", x.rangeBand())
        .attr("y", function(d) { return y(d.value); })
        .attr("height", function(d) { return height - y(d.value); });
        
    </script>    
    </div>
    </div>
</div>
<div class="row-fluid">
    History Records
    <div class="d-result ">
    <table class="table table-sm ">
    <thead>
        <tr class="table-primary sticky-top">
            <th>Date</th>
            <th>Weight</th>
            <!--<th>Height</th>-->
            <th>BMI</th>
			
            <th>BP</th>
            <th>PR</th>
            <th>Spo2</th>
			
            <th>Scoring type</th>
            <th>Scoring</th>
        </tr>
    </thead>
    <tbody>
        <% 
        isFirst = true
        for i in records 
			
		data = JSON.parse(i.data)
		weight = data['weight']
		height = data['height']
		bmi = data['bmi']		
		%>
		
        <tr class="<%=(isFirst)?"bg-primary r-first":""%>" >
            <td><%=i.stamp.strftime('%d/%m/%Y %H:%M')%></td>
            <td><%=weight%>
            <svg class="symbol">
                <use xlink:href="#t-down" />
            </svg>
			</td>
            <!--<td><%=height%>
            <svg class="symbol">
                <use xlink:href="#t-down" />
            </svg>
			</td>-->
              <td><%= bmi %></td>
			<td><%= i.bp %></td>
            <td><%= i.pr %></td>
            <td><%= i.spo2 %></td>
          
			    <td><%= 'OPD' %></td>
			  
            <td><span class="badge badge-pill badge-success badge-score"><%=i.score%></span></td>   
        </tr>
		<% isFirst=false %>
		<% end %>
        <!-- <tr>
            <td>19/04/2020</td>
            <td>66.9 </td>
            <td>120/80</td>
            <td>NEWS</td>
            <td><span class="badge badge-pill badge-warning badge-score">4</span></td>
        </tr> -->
    </tbody>
    </table>
    </div>
    <div class="col-12">
    <center>
    <a href="index" class="btn btn-primary btn-opd">เสร็จสิ้น</a>
    <a href="log" class="btn-result-cancle">view log</a> 
    </center>
    </div>
</div>


